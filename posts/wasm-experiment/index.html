<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/home/styles.78792843c2625ad72a47.css">@import url(https://fonts.googleapis.com/css?family=Nunito+Sans:400,600,700,800);@import url(https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css);.navbar{background-color:#fbfbfb!important}#banner{height:60vh;background-color:#fff;color:#173950;mask:url(/home/static/hero-mask-02df0a2bd19a714ee2bf5c468e1646b7.png) top left round;-webkit-mask:url(/home/static/hero-mask-02df0a2bd19a714ee2bf5c468e1646b7.png) top left round}#banner_title{position:relative;background-color:#fff}@media only screen and (max-width:600px){#banner{mask:url(/home/static/hero-mask-mobile-d34c086bde295ed3a033359a99223f6e.png) top left round;-webkit-mask:url(/home/static/hero-mask-mobile-d34c086bde295ed3a033359a99223f6e.png) top left round;padding-bottom:0!important}#banner_title{position:-webkit-sticky!important;position:sticky!important;top:0!important}}.container{position:relative}#banner_canvas{width:100vw;height:100vh;background-color:#fff;position:fixed}.inner_container{background-color:#fff;position:relative;overflow:auto}#banner_canvas_container{position:absolute}body{font-family:Nunito Sans,sans-serif!important;color:#173950!important}#hello{color:#f36}#back_to_main{color:#173950!important}.content_container{background-color:#fff;position:relative;overflow:hidden}.jumbotron{background-color:#fff!important}footer{background-color:#fff;position:relative;font-size:12px}a{color:#2ec4b6!important}svg{fill:#20a4f3!important}svg:hover{fill:#11679a!important}.card{border-width:0!important}.hljs{display:block;overflow-x:auto;padding:.5em;color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><meta name="generator" content="Gatsby 2.1.11"/><title data-react-helmet="true">Home | Matias Heikkilä&#x27;s homepage</title><link data-react-helmet="true" rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous"/><meta data-react-helmet="true" name="description" content="I&#x27;m doing a PhD in statistics and I write code sometimes."/><meta data-react-helmet="true" property="og:title" content="Home"/><meta data-react-helmet="true" property="og:description" content="I&#x27;m doing a PhD in statistics and I write code sometimes."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Matias Heikkilä"/><meta data-react-helmet="true" name="twitter:title" content="Home"/><meta data-react-helmet="true" name="twitter:description" content="I&#x27;m doing a PhD in statistics and I write code sometimes."/><meta data-react-helmet="true" name="keywords" content="gatsby, application, react"/><link rel="manifest" href="/home/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/home/icons/icon-48x48.png"/><link rel="apple-touch-icon" sizes="72x72" href="/home/icons/icon-72x72.png"/><link rel="apple-touch-icon" sizes="96x96" href="/home/icons/icon-96x96.png"/><link rel="apple-touch-icon" sizes="144x144" href="/home/icons/icon-144x144.png"/><link rel="apple-touch-icon" sizes="192x192" href="/home/icons/icon-192x192.png"/><link rel="apple-touch-icon" sizes="256x256" href="/home/icons/icon-256x256.png"/><link rel="apple-touch-icon" sizes="384x384" href="/home/icons/icon-384x384.png"/><link rel="apple-touch-icon" sizes="512x512" href="/home/icons/icon-512x512.png"/><link as="script" rel="preload" href="/home/webpack-runtime-36f1475e37c4350f5af5.js"/><link as="script" rel="preload" href="/home/app-2687bf5f328128ecfde1.js"/><link as="script" rel="preload" href="/home/styles-6598ff34d043dcf33a3b.js"/><link as="script" rel="preload" href="/home/1-e842abf3548387b5bda7.js"/><link as="script" rel="preload" href="/home/2-960f07a4b33a2a4b495c.js"/><link as="script" rel="preload" href="/home/3-cab02cd98ebc223d03e0.js"/><link as="script" rel="preload" href="/home/component---src-pages-posts-wasm-experiment-jsx-d96a7c123b9f63e1045e.js"/><link as="fetch" rel="preload" href="/home/static/d/191/path---posts-wasm-experiment-c-15-c8f-NZuapzHg3X9TaN1iIixfv1W23E.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div><div><nav class="navbar navbar-light"><a id="back_to_main" href="/home/"><span id="hello">Hello</span>,<br/>I&#x27;m Matias</a></nav></div><main><div class="content_container"><div class="inner_container container p-5"><div id="post_container" class="row"><div class="col-md-2"></div><div class="col-md-8"><a href="https://github.com/mahepe/box2d-wasm-experiment"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a><h2>Using Box2D and SDL2 in a WASM project</h2><p><strong>TL;DR:</strong> <em>After some initial problems with CMake I had a great experience with
C++ to WASM. During this experiment, things that compiled natively, also
compiled to WASM without any problems.</em></p><p>Recently on <a href="https://news.ycombinator.com/">HN</a>, there have been a lot of
<a href="https://webassembly.org/">WASM</a>-related posts. The ability to run native code
in the browser sounds pretty amazing and I was blown away by <a href="https://www.funkykarts.rocks/demo.html">Funky
Karts</a>, a C++ game that the author
compiled to WASM (and provided pretty detailed
<a href="https://www.rossis.red/wasm.html#emscripten">documentation</a> of the
process). So far, WASM is a nascent technology and the success of your project
shouldn&#x27;t probably depend on it. However, I wanted to get some sort of an idea
how reliable it is at the moment and what would be possible with it. As a
result, I produced <a href="https://mahepe.github.io/box2d-wasm-experiment">this</a> tiny
demo that renders things with SDL2 and uses
<a href="https://github.com/erincatto/Box2D">Box2D</a> for movement and
collision-detection. It looks pretty terrible, but I&#x27;m left convinced
that it&#x27;s possible to do <em>something</em> with WASM and even use some well-known
libraries. Check the <a href="https://github.com/mahepe/box2d-wasm-experiment">repo</a> for
further details.</p><h3>Building</h3><p>I&#x27;m under the impression that at the moment CMake is the easiest way to build
your C++ WASM project. I had no prior experience with CMake so it was pretty
painful to get the compile commands right at first. However, after getting into
terms with it, I really prefer CMake over graphical IDEs I&#x27;m used to when
linking C++.</p><p>We can define a CMake script which enables us to compile to native target like
this:</p><pre><code class="language-bash">cmake ..
make</code></pre><p>And to WASM target like this:</p><pre><code class="language-bash">emcmake cmake ..
emmake make</code></pre><p>See the <a href="https://github.com/mahepe/box2d-wasm-experiment/blob/master/CMakeLists.txt#L1-L35">full
script</a>.</p><h4>Some details</h4><p>This tells the linker where the includes and the sources are. At it&#x27;s present
form, it takes everything from <code>./src/</code>.</p><pre><code>include_directories(${CMAKE_SOURCE_DIR}/include/Box2D/)

file(GLOB SRC
    &quot;src/*.h&quot;
    &quot;src/*.cpp&quot;
)</code></pre><p>We can use a single CMake script for both native and WASM target.</p><pre><code class="language-cmake">if (${CMAKE_SYSTEM_NAME} STREQUAL &quot;Emscripten&quot;)

    # If build target WASM.

else ()

    # If build target native.

endif ()</code></pre><p>Since the native and WASM libraries have to be compiled with different
compilers, you&#x27;ll need to take that into account in linking the project. In the
following we put WASM libs to <code>./lib/web/</code> and native libs to <code>./lib/native/</code>.</p><pre><code class="language-cmake">if (${CMAKE_SYSTEM_NAME} STREQUAL &quot;Emscripten&quot;)
  # ...
  link_directories(${CMAKE_SOURCE_DIR}/lib/web)
  # ...
else ()
  # ...
  link_directories(${CMAKE_SOURCE_DIR}/lib/native)
  # ...
endif ()</code></pre><p>It&#x27;s worth pointing out that we use a different compiler for WASM.</p><pre><code class="language-cmake">if (${CMAKE_SYSTEM_NAME} STREQUAL &quot;Emscripten&quot;)
  # ...
  set(CMAKE_CXX_COMPILER &quot;em++&quot;)
  # ...
else ()
  # ...
endif ()</code></pre><p>You&#x27;ll need to make similar changes to compile commands when compiling library
that will be linked with an emscripten project.</p><h3>About the C++ part</h3><p>The demo code isn&#x27;t very interesting, I&#x27;ll describe it on a general
level. The main loop is extremely generic.</p><pre><code class="language-C++">void main_loop() {
  update();
  draw();
}</code></pre><h4>The update function</h4><p>The update function measures the time since the last frame and simulates physics
based on the elapsed time (<code>Step</code> is a function defined in Box2D <code>World</code>
class). Then any SDL events (such as keydown) are processed by first turning
them our custom event object which are then passed to game objects (physical
things you see on the screen).</p><pre><code class="language-C++">void update() {
  // Tick the timer and simulate physics.
  timer.tick();
  world-&gt;Step(timer.delta, 1, 1);

  // Loop through SDL_Events
  SDL_Event e;
  if (SDL_PollEvent(&amp;e)) {

    // Parse the SDL_Event to our custom event object.
    std::unique_ptr&lt;EventData&gt; event_data =
        std::unique_ptr&lt;EventData&gt;(new EventData(e));

    // Loop through objects
    for (auto const &amp;o : game_state-&gt;objects) {
      o-&gt;handle_event(event_data.get());
    }

    // Break from the main loop if quit received.
    run = !event_data-&gt;quit;
  }
}</code></pre><p>By the way, notice a design-decision here. I wanted to be able to pass event
data to all game objects, but they should respond to events differently based on
whether they are, for example, the player or some other object. After <a href="https://stackoverflow.com/a/307793/3616581">digging
around</a> a bit it seems that the OOP
way to do this is to inherit and override: The vector <code>game_state-&gt;objects</code>
contains objects of a generic type <code>GameObject</code> which defines a virtual event
handler that does nothing.</p><pre><code class="language-C++">class GameObject {

/* ... */

  virtual void handle_event(EventData *event_data) {}

/* ... */

};</code></pre><p>The <code>Player</code> class inherits <code>GameObject</code> and overrides the superclass
<code>handle_event</code> to change the player velocity.</p><pre><code class="language-C++">class Player : public GameObject {

/* ... */

  void handle_event(EventData *event_data) override {
  // Alter the player velocity.
  }

/* ... */

};</code></pre><p>See the <a href="https://github.com/mahepe/box2d-wasm-experiment/blob/626a8c81c6e1fac32967eef9b3cb893a554266f7/src/game_object.h#L1-L78">complete
game_object.h</a>
for details.</p><h4>The render function</h4><p>The render function is quite self-explanatory.</p><pre><code class="language-C++">void draw() {

  // Clear the screen.
  SDL_RenderClear(interface-&gt;renderer.get());

  // Invoke render() of each GameObject.
  for (auto const &amp;o : game_state-&gt;objects) {
    o-&gt;render(interface.get(), game_state-&gt;camera-&gt;GetPosition(), screen_size);
  }

  // Flip the buffers.
  SDL_RenderPresent(interface-&gt;renderer.get());
}</code></pre><p><a href="https://github.com/mahepe/box2d-wasm-experiment/blob/626a8c81c6e1fac32967eef9b3cb893a554266f7/src/game_object.h#L28-L36">The
implementation</a>
of <code>render()</code> in <code>GameObject</code> takes care of positioning the sprites according to
the Box2D body positions.</p></div><div class="col-md-2"></div></div></div></div></main><footer><div class="container text-center">© <!-- -->2019<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a>.<a href="/home/privacy"> Privacy policy</a></div></footer></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-pages-posts-wasm-experiment-jsx","jsonName":"posts-wasm-experiment-c15","path":"/posts/wasm-experiment/"};window.dataPath="191/path---posts-wasm-experiment-c-15-c8f-NZuapzHg3X9TaN1iIixfv1W23E";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-2687bf5f328128ecfde1.js"],"component---src-pages-404-jsx":["/component---src-pages-404-jsx-96594d1193f0400a9eae.js"],"component---src-pages-index-jsx":["/component---src-pages-index-jsx-dc78e07427391136cfb7.js"],"component---src-pages-posts-pixijs-effect-jsx":["/component---src-pages-posts-pixijs-effect-jsx-ec20350fef46b5d7a04e.js"],"component---src-pages-posts-wasm-experiment-jsx":["/component---src-pages-posts-wasm-experiment-jsx-d96a7c123b9f63e1045e.js"],"component---src-pages-privacy-jsx":["/component---src-pages-privacy-jsx-b14c750d5b038b49cf2d.js"],"component---src-pages-publications-jsx":["/component---src-pages-publications-jsx-885938e26c7d7dec9059.js"],"pages-manifest":["/pages-manifest-02698f73470d12565020.js"]};/*]]>*/</script><script src="/home/component---src-pages-posts-wasm-experiment-jsx-d96a7c123b9f63e1045e.js" async=""></script><script src="/home/3-cab02cd98ebc223d03e0.js" async=""></script><script src="/home/2-960f07a4b33a2a4b495c.js" async=""></script><script src="/home/1-e842abf3548387b5bda7.js" async=""></script><script src="/home/styles-6598ff34d043dcf33a3b.js" async=""></script><script src="/home/app-2687bf5f328128ecfde1.js" async=""></script><script src="/home/webpack-runtime-36f1475e37c4350f5af5.js" async=""></script></body></html>